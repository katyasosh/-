$(document).ready(function (){
    const alarmInterval = sslCertificateChecker_getAlarmInterval();
    setTimeout(sslCertificateChecker_showSslWarning, alarmInterval);
});

const sslCertificateChecker_timeoutKey = "sslCertificateChecker.timeout";
const sslCertificateChecker_defaultInterval = 24 * 60 * 60 * 1000;  // Сутки в миллисекундах

function sslCertificateChecker_isModalWindowOpened() {
    return $("body > div.popupModalOverlay").length > 0;
}

function sslCertificateChecker_notSslCertificateInstalled(qXHR, textStatus, errorThrown) {
    // Любая ошибка - сертификат не настроен
    return true;
}

function sslCertificateChecker_getAlarmInterval() {
    const alarmTimeStr = localStorage.getItem(sslCertificateChecker_timeoutKey);
    if (alarmTimeStr == null) {
        return 0;
    }
    const alarmTime = Number(alarmTimeStr);
    const alarmInterval = alarmTime - new Date().getTime();
    return alarmInterval < 0 ? 0: alarmInterval;
}

function sslCertificateChecker_setAlarmTime(intervalInMilliseconds) {
    const unixTime = new Date().getTime() + intervalInMilliseconds;
    const unixTimeStr = unixTime.toString();
    localStorage.setItem(sslCertificateChecker_timeoutKey, unixTimeStr);
    setTimeout(sslCertificateChecker_showSslWarning, intervalInMilliseconds);
}

function sslCertificateChecker_setAlarmTimeFromJson(jsonObject) {
    let checkSslInterval = jsonObject.value;
    if (checkSslInterval < 1) {
        checkSslInterval = 1;
    }
    sslCertificateChecker_setAlarmTime(
        checkSslInterval == null ? sslCertificateChecker_defaultInterval : checkSslInterval * 60 * 1000
    );
}



// Сработал таймер
function sslCertificateChecker_showSslWarning() {
    if (sslCertificateChecker_isModalWindowOpened()) {
        setTimeout(sslCertificateChecker_showSslWarning, 2000);
    } else {

        // Проверяем наличие сертификата
        $.ajax({
            type: "GET",
            url: "https://rus-ssl.zakupki.gov.ru",
            error: function (qXHR, textStatus, errorThrown) {
                if (sslCertificateChecker_notSslCertificateInstalled(qXHR, textStatus, errorThrown)) {
                    sslCertificateChecker_openSslWarning();
                }
            }
        });

        // Получаем timeout
        $.ajax({
            type: "GET",
            url: "/epz/configuration/getParameter.json?config=Common&key=CHECK_SSL.INTERVAL",
            success: function (json) {
                sslCertificateChecker_setAlarmTimeFromJson(json);
            },
            error: function (qXHR, textStatus, errorThrown) {
                sslCertificateChecker_setAlarmTime(sslCertificateChecker_defaultInterval);
            }
        });
    }
}



function sslCertificateChecker_openSslWarning() {
    const modalWindow =
          '<div class="popupModalOverlay">'
        + '    <div class="modal" id="modal-customer" role="dialog">'
        + '        <div class="modal-content modal-content-choose-organization" style="top: 261px; width: 736px; min-width: 736px; height: 320px; border-radius: 3px">'
        + '            <div id="sslCertificateChecker-left" style="width: 104px; float: left">'
        + '                <svg width="56" height="56" viewBox="0 0 56 56" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-top: 24px; margin-left: 24px;">'
        + '                    <path d="M28 56C43.5 56 56 43.5 56 28C56 12.5 43.5 0 28 0C12.5 0 0 12.5 0 28C0 43.5 12.5 56 28 56Z" fill="#0065DD"/>'
        + '                    <path fill-rule="evenodd" clip-rule="evenodd" d="M42.8517 32.3847V32.5724H42.8367V32.8352C42.8117 33.2356 42.7867 33.536 42.7728 33.7028C42.7659 33.7862 42.7617 33.8363 42.7617 33.8488C42.7314 33.9065 42.7184 33.9716 42.7243 34.0365V34.0741C42.7281 34.1756 42.7155 34.277 42.6868 34.3744V34.4119C42.3598 35.7615 41.7319 37.0193 40.8502 38.0909C40.5361 38.4881 40.1705 38.8416 39.7633 39.1421C39.7464 39.159 39.6455 39.2295 39.478 39.3465C39.2741 39.4888 38.9716 39.7002 38.6014 39.968C37.8143 40.5311 36.6523 41.2819 35.378 42.0327C33.885 42.915 32.3461 43.717 30.7679 44.4354H30.7304C30.0496 44.72 29.3289 44.8973 28.594 44.9609C28.4462 44.992 28.2951 45.0047 28.1442 44.9985H27.507C26.5415 45.0047 25.5848 44.8131 24.696 44.4354C24.6688 44.4173 24.5371 44.3533 24.3217 44.2487C23.644 43.9198 22.1387 43.189 20.4606 42.2204C20.4044 42.1829 20.3388 42.1454 20.2732 42.1078C20.2076 42.0703 20.142 42.0327 20.0858 41.9952C18.5765 41.106 17.1129 40.1412 15.7005 39.1046C15.0714 38.6224 14.5268 38.0388 14.0889 37.3777C14.0529 37.3168 14.0348 37.247 14.0366 37.1763C14.0385 37.1056 14.0603 37.0369 14.0995 36.978C14.1386 36.9192 14.1936 36.8726 14.258 36.8437C14.3225 36.8148 14.3938 36.8047 14.4637 36.8146H15.6406C15.9686 36.8146 16.1356 36.9319 16.352 37.0842C16.4817 37.1754 16.6292 37.2792 16.84 37.3777C18.1746 38.3981 19.5772 39.3262 21.0378 40.1557C22.612 41.0942 24.1113 41.845 24.8984 42.2204C24.9358 42.258 24.9358 42.258 24.9733 42.258C24.9733 42.2679 24.9773 42.2775 24.9843 42.2845C24.9913 42.2916 25.0009 42.2955 25.0108 42.2955H25.0483C25.0483 42.3055 25.0522 42.315 25.0593 42.3221C25.0663 42.3291 25.0758 42.3331 25.0858 42.3331C25.1045 42.3331 25.1139 42.3425 25.1232 42.3518C25.1326 42.3612 25.142 42.3706 25.1607 42.3706C25.2555 42.4304 25.3559 42.4807 25.4606 42.5208C26.1089 42.8091 26.8129 42.9502 27.522 42.9337H27.8219C28.0474 42.9399 28.2731 42.9274 28.4965 42.8962C28.9349 42.8672 29.3655 42.7657 29.7709 42.5959C29.7896 42.5959 29.8083 42.5865 29.8271 42.5771C29.8458 42.5677 29.8646 42.5583 29.8833 42.5583C29.902 42.5583 29.9114 42.5489 29.9208 42.5395C29.9302 42.5302 29.9395 42.5208 29.9583 42.5208C31.4574 41.8315 32.921 41.0672 34.3435 40.2308C35.5804 39.5175 36.7048 38.7667 37.4544 38.2411L38.5414 37.4528C38.8739 37.214 39.1651 36.9223 39.4034 36.5893C40.0899 35.6845 40.5524 34.6295 40.7528 33.511C40.7528 33.511 40.7902 33.1355 40.8277 32.4973V31.221C40.8652 30.4326 40.9027 29.4565 40.9027 28.4429C40.9027 27.4293 40.8652 26.4908 40.8277 25.6649V24.3885C40.7902 23.7879 40.7528 23.3749 40.7528 23.3749C40.5858 22.2464 40.1198 21.1834 39.4034 20.2965C39.1548 19.9724 38.865 19.6821 38.5414 19.4331C38.2021 19.1398 37.8385 18.8761 37.4544 18.6447C36.7048 18.1192 35.5804 17.3684 34.3435 16.6551C32.921 15.8187 31.4574 15.0544 29.9583 14.3651C29.9388 14.3437 29.9121 14.3303 29.8833 14.3275C29.8646 14.3275 29.8458 14.3182 29.8271 14.3088C29.8083 14.2994 29.7896 14.29 29.7709 14.29C29.3588 14.142 28.9313 14.0412 28.4965 13.9897C28.3841 13.9897 28.2716 13.9803 28.1592 13.9709C28.0467 13.9615 27.9343 13.9521 27.8219 13.9521H27.522C26.8166 13.9726 26.1196 14.1122 25.4606 14.3651C25.3655 14.4244 25.2651 14.4747 25.1607 14.5152H25.0483C25.0483 14.5252 25.0443 14.5347 25.0373 14.5418C25.0303 14.5488 25.0207 14.5528 25.0108 14.5528C24.2612 14.8907 22.687 15.679 21.0378 16.6551C19.0512 17.8425 17.859 18.7007 17.1567 19.2063C17.0375 19.2921 16.9324 19.3677 16.84 19.4331C16.6708 19.5573 16.5424 19.6714 16.4312 19.7701C16.1728 19.9996 16.0075 20.1464 15.6406 20.1464H14.4412C13.9539 20.1464 13.9539 19.7334 14.0664 19.5833C14.5043 18.9221 15.049 18.3385 15.6781 17.8564C17.0904 16.8197 18.554 15.8549 20.0633 14.9657C20.0917 14.9618 20.1181 14.9486 20.1383 14.9282C21.606 14.058 23.12 13.2684 24.6735 12.5631C25.5688 12.2068 26.5212 12.016 27.4845 12H28.1067C28.1817 12 28.2566 12.0094 28.3316 12.0188C28.4066 12.0282 28.4815 12.0375 28.5565 12.0375C29.2965 12.0997 30.0224 12.277 30.7079 12.5631H30.7454C32.3287 13.285 33.868 14.0998 35.3555 15.0033C36.6523 15.7541 37.7768 16.5049 38.6163 17.068C39.3285 17.5561 39.7408 17.8564 39.7783 17.8939C40.1768 18.2047 40.5411 18.5571 40.8652 18.9451C41.761 20.0075 42.3907 21.2688 42.7018 22.6241V22.6616C42.7018 22.6954 42.7093 22.7367 42.7177 22.7822C42.7279 22.838 42.7392 22.9 42.7392 22.962V22.9995C42.7695 23.0571 42.7826 23.1223 42.7767 23.1872C42.7767 23.1997 42.7809 23.2498 42.7878 23.3332C42.8017 23.5001 42.8267 23.8004 42.8517 24.2008V24.6513C42.8892 25.2144 42.9266 25.9277 42.9641 26.716V26.7911C43.0016 27.3167 43.0016 27.9174 43.0016 28.518C43.0016 28.8232 42.9919 29.1187 42.9824 29.4094C42.9732 29.6909 42.9641 29.9679 42.9641 30.2449V30.32C42.9266 31.1083 42.8892 31.8216 42.8517 32.3847ZM18.2848 22.4739C16.8605 22.4739 16.2983 23.0745 16.2983 24.6888C16.2983 26.3031 16.8605 26.9037 18.2848 26.9037C19.7091 26.9037 20.3088 26.2655 20.3088 24.6888C20.3088 23.1121 19.7466 22.4739 18.2848 22.4739ZM18.2848 25.9652C17.6476 25.9652 17.4227 25.7775 17.4227 24.6888C17.4227 23.4875 17.6476 23.4124 18.2848 23.4124C18.922 23.4124 19.1469 23.525 19.1469 24.6888C19.1469 25.8526 18.9595 25.9652 18.2848 25.9652ZM24.2817 25.815C24.2623 25.7936 24.2356 25.7802 24.2068 25.7775C23.877 25.8694 23.537 25.9199 23.1948 25.9276C22.5201 25.9276 22.1828 25.7399 22.1828 24.6888C22.1828 23.8254 22.2953 23.4499 23.1948 23.4499C23.4731 23.4554 23.7498 23.4931 24.0194 23.5626C24.0353 23.5626 24.0445 23.5626 24.0526 23.5597C24.0636 23.5558 24.0728 23.5466 24.0943 23.525L24.0943 23.525C24.1465 23.4205 24.2068 23.3079 24.2714 23.1871C24.3459 23.0478 24.4263 22.8976 24.5066 22.7367V22.6991L24.4691 22.6616C24.0415 22.5441 23.6007 22.481 23.1573 22.4739C21.6956 22.4739 21.0584 23.1496 21.0584 24.6888C21.0584 26.228 21.6956 26.9413 23.1573 26.9413C23.641 26.9428 24.1219 26.8668 24.5816 26.716C24.6191 26.716 24.6191 26.6785 24.6191 26.6409L24.2817 25.815ZM15.9985 22.5865H13.0375C13.0326 22.5865 13.0277 22.5875 13.0231 22.5894C13.0186 22.5913 13.0145 22.594 13.011 22.5975C13.0075 22.601 13.0047 22.6051 13.0029 22.6097C13.001 22.6142 13 22.6191 13 22.624V26.716C13 26.726 13.0039 26.7355 13.011 26.7426C13.018 26.7496 13.0275 26.7535 13.0375 26.7535H14.0495C14.0594 26.7535 14.0689 26.7496 14.076 26.7426C14.083 26.7355 14.0869 26.726 14.0869 26.716V23.5626H15.6237C15.6424 23.5626 15.6518 23.5626 15.6564 23.5579C15.6611 23.5532 15.6611 23.5438 15.6611 23.525C15.6939 23.4484 15.7267 23.3686 15.7604 23.2866C15.8423 23.0872 15.9297 22.8744 16.036 22.6616V22.624C16.036 22.6141 16.032 22.6045 16.025 22.5975C16.0179 22.5905 16.0084 22.5865 15.9985 22.5865ZM25.2937 28.8183H22.2578C22.2478 28.8183 22.2383 28.8223 22.2313 28.8293C22.2242 28.8363 22.2203 28.8459 22.2203 28.8558C22.142 30.2429 21.903 31.616 21.5082 32.9478V32.9853L21.5456 33.0229H22.6101C22.6288 33.0229 22.6382 33.0229 22.6429 33.0182C22.6476 33.0135 22.6476 33.0041 22.6476 32.9853C22.9657 31.9474 23.1669 30.8771 23.2473 29.7944H24.2593V32.9478C24.2593 32.9527 24.2602 32.9576 24.2621 32.9622C24.264 32.9667 24.2667 32.9709 24.2702 32.9743C24.2737 32.9778 24.2778 32.9806 24.2824 32.9825C24.2869 32.9844 24.2918 32.9853 24.2967 32.9853H25.3087C25.3187 32.9853 25.3282 32.9814 25.3352 32.9743C25.3422 32.9673 25.3462 32.9578 25.3462 32.9478L25.3087 28.8183H25.2937ZM38.2021 28.8183H37.1901C37.1802 28.8183 37.1707 28.8223 37.1636 28.8293C37.1566 28.8363 37.1527 28.8459 37.1527 28.8558V32.0093C36.9334 32.0712 36.7055 32.0966 36.478 32.0844C35.8034 32.0844 35.6534 31.8967 35.6534 30.9957V28.8183C35.6534 28.8083 35.6495 28.7988 35.6425 28.7918C35.6354 28.7847 35.6259 28.7808 35.616 28.7808H34.604C34.594 28.7808 34.5845 28.7847 34.5775 28.7918C34.5704 28.7988 34.5665 28.8083 34.5665 28.8183V31.1458C34.5665 32.5724 35.0537 33.1355 36.2906 33.1355C36.9574 33.1271 37.6173 33 38.2396 32.7601C38.2496 32.7601 38.2591 32.7561 38.2661 32.7491C38.2731 32.7421 38.2771 32.7325 38.2771 32.7226V28.8558C38.2771 28.8183 38.2396 28.8183 38.2021 28.8183ZM17.1229 28.8183H16.1109C16.0922 28.8183 16.0828 28.8183 16.0781 28.823C16.0734 28.8277 16.0734 28.8371 16.0734 28.8558C15.8275 29.7985 15.5271 30.7261 15.1739 31.6339L14.1244 28.8558C14.1244 28.8459 14.1205 28.8363 14.1134 28.8293C14.1064 28.8223 14.0969 28.8183 14.0869 28.8183H13.0375C13.0326 28.8183 13.0277 28.8193 13.0231 28.8212C13.0186 28.823 13.0145 28.8258 13.011 28.8293C13.0075 28.8328 13.0047 28.8369 13.0029 28.8415C13.001 28.846 13 28.8509 13 28.8558V28.8934L14.5367 33.0604C14.4109 33.3482 14.2604 33.6245 14.0869 33.8863C14.0307 33.9802 13.9839 34.074 13.937 34.1679C13.8902 34.2617 13.8433 34.3556 13.7871 34.4494V34.487L13.8246 34.5245H14.949C14.9677 34.5245 14.9771 34.5245 14.9818 34.5198C14.9865 34.5151 14.9865 34.5058 14.9865 34.487C15.1739 34.1116 15.3988 33.6235 15.6237 33.098C16.2214 31.7078 16.7224 30.2778 17.1229 28.8183ZM20.7585 32.0093C20.7391 31.9879 20.7124 31.9745 20.6836 31.9717C20.3538 32.0637 20.0138 32.1141 19.6716 32.1219C18.9969 32.1219 18.6596 31.9342 18.6596 30.8831C18.6596 30.0196 18.7721 29.6442 19.6716 29.6442C19.9499 29.6496 20.2266 29.6874 20.4962 29.7568C20.5121 29.7568 20.5213 29.7568 20.5294 29.7539C20.5404 29.75 20.5496 29.7409 20.5711 29.7193C20.6233 29.6148 20.6836 29.5022 20.7481 29.3815L20.7482 29.3814C20.8227 29.242 20.9031 29.0919 20.9834 28.9309V28.8934L20.9459 28.8558C20.5183 28.7383 20.0775 28.6752 19.6341 28.6681C18.1724 28.6681 17.5352 29.3439 17.5352 30.8831C17.5352 32.4222 18.1724 33.1355 19.6341 33.1355C20.1178 33.137 20.5987 33.061 21.0584 32.9103C21.0959 32.9103 21.0959 32.8727 21.0959 32.8352L20.7585 32.0093ZM30.2037 28.8183H29.1917C29.173 28.8183 29.1636 28.8183 29.1589 28.823C29.1543 28.8277 29.1543 28.8371 29.1543 28.8558C28.9083 29.7985 28.6079 30.7261 28.2547 31.6339L27.2427 28.8558C27.2427 28.8509 27.2418 28.846 27.2399 28.8415C27.238 28.8369 27.2352 28.8328 27.2317 28.8293C27.2283 28.8258 27.2241 28.823 27.2196 28.8212C27.215 28.8193 27.2102 28.8183 27.2052 28.8183H26.1183C26.1084 28.8183 26.0988 28.8223 26.0918 28.8293C26.0848 28.8363 26.0808 28.8459 26.0808 28.8558V28.8934L27.6175 33.0604C27.4917 33.3482 27.3412 33.6245 27.1678 33.8863C27.1115 33.9802 27.0647 34.074 27.0178 34.1679C26.971 34.2617 26.9241 34.3556 26.8679 34.4494V34.487L26.9054 34.5245H28.0298C28.0673 34.5245 28.0673 34.5245 28.0673 34.487C28.2547 34.1116 28.4796 33.6235 28.7045 33.098C29.308 31.71 29.8091 30.2796 30.2037 28.8183ZM33.9143 28.8183H30.9908C30.9859 28.8183 30.981 28.8193 30.9765 28.8212C30.9719 28.823 30.9678 28.8258 30.9643 28.8293C30.9608 28.8328 30.9581 28.8369 30.9562 28.8415C30.9543 28.846 30.9533 28.8509 30.9533 28.8558V32.9478C30.9533 32.9527 30.9543 32.9576 30.9562 32.9622C30.9581 32.9667 30.9608 32.9709 30.9643 32.9743C30.9678 32.9778 30.9719 32.9806 30.9765 32.9825C30.981 32.9844 30.9859 32.9853 30.9908 32.9853H32.0028C32.0077 32.9853 32.0126 32.9844 32.0171 32.9825C32.0217 32.9806 32.0258 32.9778 32.0293 32.9743C32.0305 32.9732 32.0316 32.9719 32.0326 32.9706C32.0345 32.968 32.0362 32.9652 32.0374 32.9622C32.0393 32.9576 32.0403 32.9527 32.0403 32.9478V29.7944H33.577C33.6145 29.7944 33.6145 29.7944 33.6145 29.7568C33.6472 29.6802 33.68 29.6004 33.7137 29.5184L33.7137 29.5183C33.7957 29.3189 33.8831 29.1061 33.9893 28.8934V28.8558C33.9677 28.8342 33.9586 28.8251 33.9475 28.8212C33.9394 28.8183 33.9302 28.8183 33.9143 28.8183Z" fill="white"/>'
        + '                </svg>'
        + '            </div>'
        + '            <div id="sslCertificateChecker-right" style="width: 40px; float: right; padding-top: 24px">'
        + '                <span class="btn-close closePopUp" data-close="modal" style="width: 16px; height: 16px">'
        + '                    <img src="/epz/static/img/icons/icon_cross.svg" alt="">'
        + '                </span>'
        + '            </div>'
        + '            <div id="sslCertificateChecker-center" style="margin: 0 40px 0 104px">'
        + '                <div style="padding-top: 38px; font-family: Roboto; font-size: 19px; font-weight: 500; line-height: 24px; letter-spacing: 0em; text-align: left; width: 500px">'
        + '                    Установите сертификаты Минцифры РФ'
        + '                </div>'
        + '                <div style="padding-top: 32px; font-family: Roboto; font-size: 13px; font-weight: 400; line-height: 20px;letter-spacing: 0em">'
        + '                    Для получения защищенного доступа к Официальному сайту Единой информационной системы в сфере закупок установите сертификаты'
        + '                    безопасности, выпущенные НУЦ Минцифры РФ.'
        + '                    <br><br>'
        + '                    Это необходимо, поскольку работа многих браузеров с иностранными сертификатами ограничена. Установка новых сертификатов на'
        + '                    ваше устройство обеспечит надёжное и защищённое подключение, которое позволит всегда иметь доступ к ГИС ЕИС Закупки.'
        + '                    <br><br>'
        + '                    <a href="https://www.gosuslugi.ru/crt" target="_blank" style="color: #0065DD">Инструкция</a> по установке сертификатов доступна на сайте Госуслуги.'
        + '                </div>'
        + '            </div>'
        + '        </div>'
        + '    </div>'
        + '</div>';

    $("body").append(modalWindow);
}
